<!DOCTYPE html><html><head><link rel="icon" type="icon/png" href="test.png"><script>
var window = window;
var console = window.console;
var log = function (log) { window.console.log (log); };
var canvas = window.document.createElement ('canvas');
var context = canvas.getContext ('2d');
var game =
{
	canvas:
	{
		load: function ()
		{
			canvas.resize = function ()
			{
				this.height = game.window.height;
				this.width = game.window.width;
			};
		}
	},

	create:
	{
		sprite: function (sprite)
		{
			sprite.type = 'sprite';
			sprite.id = game.id++;
			sprite.name = sprite.name || sprite.type + sprite.id;

			sprite.image = sprite.image || new Image ();
			sprite.redraw = sprite.redraw || true;

			sprite.height = game.height (sprite);
			sprite.width = game.width (sprite);
			sprite.x = game.x (sprite);
			sprite.y = game.y (sprite);
			sprite.z = game.z (sprite);

			sprite.clear = function ()
			{
				game.draw.clear (sprite);
			};

			sprite.draw = function ()
			{
				game.draw.image ({ height: sprite.height, image: game.image.test, width: sprite.width, x: sprite.x, y: sprite.y });
			};

			sprite.fix = function ()
			{
				for (var z in game.scene)
				{
					var layer = game.scene[z];
					for (var i = layer.length; i--;)
					{
						if (sprite.under (layer[i]))
						{
							layer[i].redraw = true;
						};
					};
				};
			};

			sprite.move = function (a, b)
			{
				sprite.clear ();
				sprite.fix ();
				sprite.x = a;
				sprite.y = b;
				sprite.x = game.x (sprite);
				sprite.y = game.y (sprite);
				game.draw.scene = true;
			};

			sprite.under = function (o)
			{
				return ((Math.abs (sprite.x - o.x) <= sprite.width) && (Math.abs (sprite.y - o.y) <= sprite.height));
			};

			//TODO clickable sprite
			sprite.click = (sprite.click) ? game.update.click
			(
				function (event)
				{
					if (sprite.under ({ x: event.x, y: event.y })) { sprite.click (); };
				}
			) : undefined;
			
			game.scene[sprite.z].push (sprite);
		}
	},

	draw:
	{
		clear: function (object)
		{
			var o = game.draw.size (object);
			context.clearRect (o.x, o.y, o.width, o.height);
		},

		image: function (image)
		{
			var i = image.image;
			var o = game.draw.size (image);
			context.drawImage (i, o.x, o.y, o.width, o.height);
		},

		resize: false,

		scene: false,

		size: function (o)
		{
			var size = {};
				size.height = o.height * game.window.height >> 0 || o.naturalHeight;
				size.width = o.width * game.window.width >> 0 || o.naturalWidth;
				size.x = o.x * game.window.width >> 0;
				size.y = o.y * game.window.height >> 0;
			return size;
		},

		update: function ()
		{
			if (game.draw.scene)
			{
				for (var z = 0; z < Object.keys (game.scene).length; z++)
				{
					for (var id = game.scene[z].length; id-- ;)
					{
						if (game.draw.resize || game.scene[z][id].redraw)
						{
							game.scene[z][id].redraw = false;
							context.clearRect (game.scene[z][id].x, game.scene[z][id].y, game.scene[z][id].width, game.scene[z][id].height);
							game.scene[z][id].draw ();
						};
					};
				};
				game.draw.resize = false;
				game.draw.scene = false;
			};
		}
	},

	height: function (o)
	{
		var height = o.height || o.image.naturalHeight;
			height = (height > 1) ? height / game.window.height : height;
		o.redraw = true;
		return height;		
	},

	id: 0,

	image:
	{
		load: function ()
		{
			for (var id in game.image)
			{
				if (id != 'load')
				{
					var image = new Image ();
						image.src = game.image [id];
					game.image[id] = image;
				};
			};
		},
		test: 'test.png'
	},

	load: function ()
	{
		game.image.load ();
		game.canvas.load ();
		game.window.load ();
		game.timer.load ();
	},

	scene: { 0: [] },

	timer:
	{
		clock: {},
		load: function ()
		{
			game.timer.clock = window.setInterval
			(
				function ()
				{
					game.update.tick ();
					game.timer.time += game.timer.tick;
				},
				game.timer.tick
			);
		},
		tick: 50,
		time: 0
	},

	update:
	{
		click: function (event)
		{
			switch (typeof (event))
			{
				case 'function':
					game.update.event.click.push (event);
				break;

				default:
					var tile = 15;
					game.create.sprite ({ click: function () { log (this); }, height: tile, image: game.image.test, width: tile, x: event.clientX, y: event.clientY });

					for (var i = game.update.event.click.length; i--;)
					{
						game.update.event.click[i](event);
					};

					game.draw.scene = true;
			};
		},

		event: { click: [] },

		resize: function ()
		{
			window.resize ();
			canvas.resize ();
			game.draw.resize = true;
			game.draw.scene = true;
		},

		tick: function ()
		{
			game.draw.update ();
		}
	},

	width: function (o)
	{
		var width = o.width || o.image.naturalWidth;
			width = (width > 1) ? width / game.window.width : width;
		o.redraw = true;
		return width;
	},

	window:
	{
		height: undefined,

		load: function ()
		{
			window.onclick = function (event)
			{
				game.update.click (event);
			};

			window.onload = function ()
			{
				game.update.resize ();
				this.document.body.appendChild (canvas);
			};

			window.onresize = function ()
			{
				game.update.resize ();
			};

			window.resize = function ()
			{
				game.window.height = this.innerHeight;
				game.window.width = this.innerWidth;
			};

			window.document.title = '0.' + JSON.stringify (game).length;
		},

		width: undefined
	},

	x: function (o)
	{
		var x = o.x || 0;
			x = (x > 1) ? x / game.window.width : x;
		o.redraw = true;
		return x;
	},

	y: function (o)
	{
		var y = o.y || 0;
			y = (y > 1) ? y / game.window.height : y;
		o.redraw = true;
		return y;
	},

	z: function (o)
	{
		var z = o.z || 0;
		if (z > Object.keys (game.scene).length)
		{
			game.scene[z].push ([]);
		};
		o.redraw = true;
		return z;
	}
};

game.load ();
</script><style>
	body { margin: 0; }
	canvas { position: absolute; }
</style></head></html>